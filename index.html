<!DOCTYPE html>
<html lang="en">

<head>
   <title>Battleship</title>
   <link rel="stylesheet" href="style.css">
   <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap">

   <!--React is the main library-->
   <script src="https://unpkg.com/react@16/umd/react.development.js"></script>

   <!--ReactDOM is a special package that allows us to take react components-->
   <!--and insert into the Document Object Model (DOM)-->
   <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>

   <!--Babel translates JSX into javascript-->
   <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>

<body>
   <div id="app"></div>

   <!--Whenever scripting in JSX, you must add attribute type="text/babel" to translate to javascript-->
   <script type="text/babel">

      class StaticGrid extends React.Component {
         getTileStyle = (offset) => {
            const boatColours = {
               L: 'orange',
               Box: 'yellow',
               Line1: 'cyan',
               Line2: 'blue'
            }

            let style = {
               backgroundColor: boatColours[this.props.player.boats.get(offset)]
            }

            return style
         }

         render() {
            const player = this.props.player
            const gridItems = [];
            const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

            gridItems.push(<div />)
            // Header for columns
            for (let i = 0; i < 8; i++) {
               gridItems.push(<div className="header-column">{i + 1}</div>)
            }

            for (let i = 0; i < 8; i++) {
               // Header for rows
               gridItems.push(<div className="header-row">{letters[i]}</div>)

               for (let j = 0; j < 8; j++) {
                  const offset = 8 * i + j

                  // Check if this square has been hit yet
                  const hit = player.hits.has(offset)

                  // If it has been hit, check to determine a hit or miss
                  var icon = null
                  if (hit) {
                     if (player.boats.has(offset)) {
                        icon = <img src="images/kaboom.png" width="90%" height="90%" />
                     } else {
                        icon = <img src="images/x.png" width="90%" height="90%" />
                     }
                  }

                  // Manipulating style to indicate positions of boats and hits
                  const style = this.getTileStyle(offset);

                  gridItems.push(
                     <button className="button-grid" disabled={true} style={style}>
                        {icon}
                     </button>)
               }
            }

            return (
               <div className="grid">
                  {gridItems}
               </div>
            )
         }
      }

      class BoatList extends React.Component {
         render() {
            const length = 50
            const width = 50

            const boatElements = [];
            const imageSource = [];
            const boatLives = this.props.boats
            if (boatLives.L) {
               imageSource.push("images/L.png")
            } else {
               imageSource.push("images/L crossed.png")
            }

            if (boatLives.Box) {
               imageSource.push("images/Box.png")
            } else {
               imageSource.push("images/Box crossed.png")
            }

            if (boatLives.Line1) {
               imageSource.push("images/Line1.png")
            } else {
               imageSource.push("images/Line1 crossed.png")
            }

            if (boatLives.Line2) {
               imageSource.push("images/Line2.png")
            } else {
               imageSource.push("images/Line2 crossed.png")
            }

            for (const src of imageSource) {
               boatElements.push(<img src={src} length={length} width={width} />);
            }
            return (
               <div className="boat-list">
                  {boatElements}
               </div>
            )
         }
      }

      class Statistics extends React.Component {
         render() {
            const p1 = this.props.p1;
            const p2 = this.props.p2;

            const p1Stats = []
            const p2Stats = []


            p1Stats.push(<div>Total shots fired: {p2.hits.size}</div>)
            p2Stats.push(<div>Total shots fired: {p1.hits.size}</div>)

            var p1SunkenShips = 0
            for (const [key, value] of Object.entries(p1.life)) {
               if (value == 0) {
                  p1SunkenShips++;
               }
            }

            var p2SunkenShips = 0
            for (const [key, value] of Object.entries(p2.life)) {
               if (value == 0) {
                  p2SunkenShips++;
               }
            }

            p1Stats.push(<div>Ships sunk: {p2SunkenShips} </div>)
            p2Stats.push(<div>Ships sunk: {p1SunkenShips} </div>)


            return (
               <div id="container2">
                  <div>
                     <h1>Player 1</h1>
                     <hr />
                     {p1Stats}
                  </div>
                  <div>
                     <h1>Player 2</h1>
                     <hr />
                     {p2Stats}
                  </div>
               </div>
            )
         }
      }

      class App extends React.Component {
         constructor(props) {
            super(props);

            const boatsP1 = this.generateBoatSet();
            const boatsP2 = this.generateBoatSet();

            this.state = {
               player1Turn: true,
               endTurn: false,

               player1: {
                  boats: boatsP1,
                  hits: new Set(),

                  life: {
                     L: 4,
                     Box: 4,
                     Line1: 4,
                     Line2: 4
                  }
               },

               player2: {
                  boats: boatsP2,
                  hits: new Set(),

                  life: {
                     L: 4,
                     Box: 4,
                     Line1: 4,
                     Line2: 4
                  }
               },

               gameState: "lobby"
            };

         }

         resetGame = () => {
            const boatsP1 = this.generateBoatSet();
            const boatsP2 = this.generateBoatSet();

            this.setState(state => ({
               player1Turn: true,
               endTurn: false,

               player1: {
                  boats: boatsP1,
                  hits: new Set(),

                  life: {
                     L: 4,
                     Box: 4,
                     Line1: 4,
                     Line2: 4
                  }
               },

               player2: {
                  boats: boatsP2,
                  hits: new Set(),

                  life: {
                     L: 4,
                     Box: 4,
                     Line1: 4,
                     Line2: 4
                  }
               },

               gameState: "lobby"
            }));
         }

         loadGame = () => {
            const saveState = JSON.parse(localStorage.getItem("state"))

            this.setState(state => ({
               player1Turn: saveState.player1Turn,
               endTurn: saveState.endTurn,

               player1: {
                  boats: new Map(saveState.player1.boats),
                  hits: new Set(saveState.player1.hits),

                  life: {
                     L: saveState.player1.life.L,
                     Box: saveState.player1.life.Box,
                     Line1: saveState.player1.life.Line1,
                     Line2: saveState.player1.life.Line2
                  }
               },

               player2: {
                  boats: new Map(saveState.player2.boats),
                  hits: new Set(saveState.player2.hits),

                  life: {
                     L: saveState.player2.life.L,
                     Box: saveState.player2.life.Box,
                     Line1: saveState.player2.life.Line1,
                     Line2: saveState.player2.life.Line2
                  }
               },

               gameState: "transition"
            }));
         }

         saveGame = () => {
            const saveState = JSON.parse(JSON.stringify(this.state))

            // Since JSON does not support maps and sets, convert them to arrays
            saveState.player1.boats = Array.from(this.state.player1.boats.entries())
            saveState.player1.hits = Array.from(this.state.player1.hits)

            saveState.player2.boats = Array.from(this.state.player2.boats.entries())
            saveState.player2.hits = Array.from(this.state.player2.hits)


            localStorage.setItem("state", JSON.stringify(saveState))
         }

         generateBoatSet() {
            const boats = new Map();
            var orientation
            var row
            var column

            // generating L boat
            orientation = Math.floor(Math.random() * 4)
            if (orientation == 0 || orientation == 2) {
               row = Math.floor(Math.random() * 6)
               column = Math.floor(Math.random() * 7)
            } else {
               row = Math.floor(Math.random() * 7)
               column = Math.floor(Math.random() * 6)
            }

            if (orientation == 0) {
               boats.set(8 * (row) + (column), 'L')
               boats.set(8 * (row + 1) + column, 'L')
               boats.set(8 * (row + 2) + column, 'L')
               boats.set(8 * (row + 2) + column + 1, 'L')
            } else if (orientation == 1) {
               boats.set(8 * (row + 1) + column, 'L')
               boats.set(8 * (row + 1) + (column + 1), 'L')
               boats.set(8 * (row + 1) + (column + 2), 'L')
               boats.set(8 * (row) + (column + 2), 'L')
            } else if (orientation == 2) {
               boats.set(8 * (row) + (column), 'L')
               boats.set(8 * (row) + (column + 1), 'L')
               boats.set(8 * (row + 1) + (column + 1), 'L')
               boats.set(8 * (row + 2) + (column + 1), 'L')
            } else {
               boats.set(8 * (row) + (column), 'L')
               boats.set(8 * (row + 1) + (column), 'L')
               boats.set(8 * (row) + (column + 1), 'L')
               boats.set(8 * (row) + (column + 2), 'L')
            }

            // generating box boat
            row = Math.floor(Math.random() * 7)
            column = Math.floor(Math.random() * 7)
            while (boats.has(8 * row + column) || boats.has(8 * (row + 1) + column) || boats.has(8 * row + (column + 1)) || boats.has(8 * (row + 1) + (column + 1))) {
               row = Math.floor(Math.random() * 7)
               column = Math.floor(Math.random() * 7)
            }
            boats.set(8 * (row) + (column), 'Box')
            boats.set(8 * (row + 1) + (column), 'Box')
            boats.set(8 * (row) + (column + 1), 'Box')
            boats.set(8 * (row + 1) + (column + 1), 'Box')

            // generating the two line boats
            for (let i = 0; i < 2; i++) {
               orientation = Math.floor(Math.random() * 2)
               if (orientation == 0) {
                  row = Math.floor(Math.random() * 5)
                  column = Math.floor(Math.random() * 8)
                  while (boats.has(8 * row + column) || boats.has(8 * (row + 1) + column) || boats.has(8 * (row + 2) + column) || boats.has(8 * (row + 3) + column)) {
                     row = Math.floor(Math.random() * 5)
                     column = Math.floor(Math.random() * 8)
                  }

                  boats.set(8 * (row) + (column), 'Line' + (i + 1))
                  boats.set(8 * (row + 1) + (column), 'Line' + (i + 1))
                  boats.set(8 * (row + 2) + (column), 'Line' + (i + 1))
                  boats.set(8 * (row + 3) + (column), 'Line' + (i + 1))

               } else {
                  row = Math.floor(Math.random() * 8)
                  column = Math.floor(Math.random() * 5)
                  while (boats.has(8 * row + column) || boats.has(8 * row + (column + 1)) || boats.has(8 * row + (column + 2)) || boats.has(8 * row + (column + 3))) {
                     row = Math.floor(Math.random() * 8)
                     column = Math.floor(Math.random() * 5)
                  }

                  boats.set(8 * (row) + (column), 'Line' + (i + 1))
                  boats.set(8 * (row) + (column + 1), 'Line' + (i + 1))
                  boats.set(8 * (row) + (column + 2), 'Line' + (i + 1))
                  boats.set(8 * (row) + (column + 3), 'Line' + (i + 1))

               }
            }

            return boats
         }

         grid(playerID, mode) {
            const gridItems = [];
            const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

            gridItems.push(<div />)
            // Header for columns
            for (let i = 0; i < 8; i++) {
               gridItems.push(<div className="header-column">{i + 1}</div>)
            }

            for (let i = 0; i < 8; i++) {
               // Header for rows
               gridItems.push(<div className="header-row">{letters[i]}</div>)

               for (let j = 0; j < 8; j++) {
                  const offset = 8 * i + j

                  // Check if this square has been hit yet
                  const hit = this.state[playerID].hits.has(offset)

                  // If it has been hit, check to determine a hit or miss
                  var icon = null
                  if (hit) {
                     if (this.state[playerID].boats.has(offset)) {
                        icon = <img src="images/kaboom.png" width="90%" height="90%" />
                     } else {
                        icon = <img src="images/x.png" width="90%" height="90%" />
                     }
                  }
                  // Give each button a unique auto-increment value to identify
                  // If a given button has already been hit, don't give ability to hit it again
                  gridItems.push(
                     <button className="button-grid" disabled={hit || this.state.endTurn || this.state.gameState != "game"} onClick={() => this.registerHit(offset, playerID)}>
                        {icon}
                     </button>)
               }
            }

            return (
               <div className="grid">
                  {gridItems}
               </div>
            )
         }

         registerHit = (offset, playerID) => {
            // Add hit to set of hits on player's board
            this.setState(state => ({
               [playerID]: {
                  ...state[playerID],
                  hits: new Set(state[playerID].hits).add(offset)
               }
            }));

            // If a hit shot a boat, decrement its health
            if (this.state[playerID].boats.has(offset)) {
               const boat = this.state[playerID].boats.get(offset)
               const boatLife = this.state[playerID].life[boat]

               this.setState(state => ({
                  [playerID]: {
                     ...state[playerID],
                     life: {
                        ...state[playerID].life,
                        [boat]: boatLife - 1
                     }
                  }
               }), () => {
                  // Check to see if player has any remaining boats after a successful hit
                  const playerHealth = this.state[playerID].life
                  if (playerHealth.L == 0 && playerHealth.Box == 0 && playerHealth.Line1 == 0 && playerHealth.Line2 == 0) {
                     var winner;
                     if (playerID == "player1") {
                        winner = "Player 2"
                     } else {
                        winner = "Player 1"
                     }
                     this.setState(state => ({
                        gameState: "game over",
                        winner: winner
                     }));

                     // remove finished game from localStorage
                     localStorage.removeItem("state")
                  }
               });
            }

            // The player picked a tile, so now their turn is over
            this.setState(state => ({
               endTurn: true
            }));
         }

         render() {
            const gameState = this.state.gameState;
            if (gameState == "lobby") {
               return this.lobby()
            }

            if (gameState == "game") {
               return this.mainGame()
            }

            if (gameState == "transition") {
               return this.transition()
            }

            if (gameState == "game over") {
               return this.gameOver()
            }
         }

         lobby() {
            return (
               <div>
                  <h1 className="title">Battleship</h1>
                  <button className="button-big" onClick={this.startGame}>Start Game</button>
                  <button className="button-big" disabled={!localStorage.getItem("state")} onClick={this.loadGame}>Resume Game</button>
               </div>
            )
         }

         mainGame() {
            return (
               <div>
                  <div id="container">
                     <div>
                        <h2>Your grid ({this.state.player1Turn ? 'P1' : 'P2'})</h2>
                        <hr />
                        {this.state.player1Turn
                           ?
                           <div>
                              <StaticGrid player={this.state.player1} />
                              <BoatList boats={this.state.player1.life} />
                           </div>
                           :
                           <div>
                              <StaticGrid player={this.state.player2} />
                              <BoatList boats={this.state.player2.life} />
                           </div>
                        }
                     </div>
                     <div>
                        <h2>Opponent ({this.state.player1Turn ? 'P2' : 'P1'})</h2>
                        <hr />
                        {this.state.player1Turn
                           ?
                           <div>
                              {this.grid('player2', "opponent")}
                              <BoatList boats={this.state.player2.life} />
                           </div>
                           :
                           <div>
                              {this.grid('player1', "opponent")}
                              <BoatList boats={this.state.player1.life} />
                           </div>
                        }
                     </div>
                  </div>

                  <button className="button-big" disabled={!this.state.endTurn || this.state.gameState != "game"} onClick={this.switchTurns}>End Turn</button>

               </div>
            );
         }

         transition() {
            var nextPlayer;
            if (this.state.player1Turn) {
               nextPlayer = "Player 1"
            } else {
               nextPlayer = "Player 2"
            }
            return (
               <div className="title">
                  <h1>{nextPlayer}'s turn</h1>
                  <h2>Pass the screen to {nextPlayer} and press to proceed</h2>

                  <button className="button-big" onClick={this.proceedTransition}>Continue</button>
               </div>
            )
         }

         gameOver() {
            const main = this.mainGame()
            return (
               <div>
                  <div className="title">
                     <h1>GAME OVER</h1>
                     <h2>{this.state.winner} is the winner!</h2>
                  </div>
                  <Statistics p1={this.state.player1} p2={this.state.player2} />
                  <button className="button-big" onClick={this.resetGame}>Play Again</button>
                  <br />
                  {main}
               </div>
            )
         }

         startGame = () => {
            this.setState(state => ({
               gameState: "game"
            }), () => {
               this.saveGame()
            })
         }

         switchTurns = () => {
            this.setState(state => ({
               player1Turn: !state.player1Turn,
               endTurn: false,
               gameState: "transition"
            }), () => {
               this.saveGame()
            });
         }

         proceedTransition = () => {
            this.setState(state => ({
               gameState: "game"
            }));
         }
      }

      ReactDOM.render(<App />, document.querySelector('#app'));
   </script>
</body>

</html>